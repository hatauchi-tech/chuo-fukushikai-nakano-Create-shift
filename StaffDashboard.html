<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIシフト作成アプリ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- ヘッダー -->
  <header class="bg-blue-600 text-white p-4 shadow-md">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-xl font-bold">AIシフト作成アプリ</h1>
      <div class="flex items-center space-x-4">
        <nav id="mainNav" class="flex space-x-2">
          <button onclick="showPage('request')" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded text-sm">
            休み希望提出
          </button>
        </nav>
        <span id="userName" class="text-sm"></span>
        <button onclick="logout()" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded text-sm">
          ログアウト
        </button>
      </div>
    </div>
  </header>

  <!-- メインコンテンツ -->
  <main class="container mx-auto p-4 max-w-6xl">
    <!-- 休み希望提出セクション -->
    <div id="pageRequest" class="page-content">
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-lg font-bold mb-2">休み希望について</h2>
        <p class="text-sm text-gray-600">
          来月の休み希望日をカレンダーから選択してください。<br>
          選択した日付は青色で表示されます。もう一度クリックすると選択を解除できます。
        </p>
      </div>

      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex items-center space-x-4">
          <label class="text-sm font-medium text-gray-700">対象月</label>
          <input
            type="month"
            id="targetMonth"
            class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
          <button
            onclick="loadRequestData()"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
          >
            読み込み
          </button>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-lg font-bold mb-4">カレンダー</h3>
        <div id="calendar" class="grid grid-cols-7 gap-2"></div>
      </div>

      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-lg font-bold mb-4">イベント・お知らせ</h3>
        <div id="eventList" class="space-y-2"></div>
      </div>

      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">特記事項（任意）</label>
        <textarea
          id="notes"
          rows="3"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="その他の連絡事項があれば記入してください"
        ></textarea>
      </div>

      <div class="flex justify-end space-x-4">
        <button
          onclick="submitRequest()"
          class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-medium"
        >
          休み希望を提出
        </button>
      </div>
    </div>

    <!-- シフト管理セクション（管理者のみ） -->
    <div id="pageShift" class="page-content hidden">
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-lg font-bold mb-4">シフト自動生成</h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">対象月</label>
            <input
              type="month"
              id="shiftTargetMonth"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">対象グループ</label>
            <div class="grid grid-cols-3 gap-2">
              <label class="flex items-center space-x-1">
                <input type="checkbox" name="targetGroups" value="1" class="rounded">
                <span class="text-sm">G1</span>
              </label>
              <label class="flex items-center space-x-1">
                <input type="checkbox" name="targetGroups" value="2" class="rounded">
                <span class="text-sm">G2</span>
              </label>
              <label class="flex items-center space-x-1">
                <input type="checkbox" name="targetGroups" value="3" class="rounded">
                <span class="text-sm">G3</span>
              </label>
              <label class="flex items-center space-x-1">
                <input type="checkbox" name="targetGroups" value="4" class="rounded">
                <span class="text-sm">G4</span>
              </label>
              <label class="flex items-center space-x-1">
                <input type="checkbox" name="targetGroups" value="5" class="rounded">
                <span class="text-sm">G5</span>
              </label>
              <label class="flex items-center space-x-1">
                <input type="checkbox" name="targetGroups" value="6" class="rounded">
                <span class="text-sm">G6</span>
              </label>
            </div>
          </div>

          <div class="flex items-end">
            <button
              onclick="generateShift()"
              class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-medium"
            >
              シフト自動生成
            </button>
          </div>
        </div>

        <div id="feedback" class="hidden bg-yellow-50 border border-yellow-200 p-4 rounded">
          <h3 class="font-bold text-sm mb-2">AIフィードバック</h3>
          <p id="feedbackText" class="text-sm"></p>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-bold">シフト表</h2>
          <button
            onclick="exportPdf()"
            id="exportButton"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
            disabled
          >
            PDF出力
          </button>
        </div>

        <div id="shiftTableContainer" class="overflow-x-auto">
          <p class="text-gray-500 text-center py-8">シフトを生成してください</p>
        </div>
      </div>
    </div>

    <!-- マスタ管理セクション（管理者のみ） -->
    <div id="pageMaster" class="page-content hidden">
      <div class="bg-white rounded-lg shadow mb-6">
        <div class="flex border-b">
          <button
            onclick="showMasterTab('staff')"
            id="tabStaff"
            class="px-6 py-3 font-medium border-b-2 border-blue-600 text-blue-600"
          >
            職員マスタ
          </button>
          <button
            onclick="showMasterTab('shift')"
            id="tabShift"
            class="px-6 py-3 font-medium text-gray-600 hover:text-gray-800"
          >
            シフトマスタ
          </button>
          <button
            onclick="showMasterTab('rule')"
            id="tabRule"
            class="px-6 py-3 font-medium text-gray-600 hover:text-gray-800"
          >
            ルールマスタ
          </button>
          <button
            onclick="showMasterTab('event')"
            id="tabEvent"
            class="px-6 py-3 font-medium text-gray-600 hover:text-gray-800"
          >
            イベント管理
          </button>
        </div>
      </div>

      <div id="masterContent" class="bg-white rounded-lg shadow p-6">
        <p class="text-gray-500 text-center">マスタ管理機能は開発中です</p>
      </div>
    </div>

    <!-- メッセージ -->
    <div id="message" class="hidden mt-4 p-4 rounded"></div>
  </main>

  <script>
    let selectedDates = new Set();
    let currentMonth = null;
    let currentUser = null;
    let currentTableId = null;
    let currentShiftData = [];

    // 初期化
    window.onload = function() {
      // セッション情報を取得
      google.script.run
        .withSuccessHandler(function(user) {
          if (user) {
            currentUser = user;
            document.getElementById('userName').textContent = user.name;

            // 管理者の場合、ナビゲーションを追加
            if (user.role === '管理者') {
              const nav = document.getElementById('mainNav');
              nav.innerHTML = `
                <button onclick="showPage('request')" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded text-sm">
                  休み希望提出
                </button>
                <button onclick="showPage('shift')" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded text-sm">
                  シフト管理
                </button>
                <button onclick="showPage('master')" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded text-sm">
                  マスタ管理
                </button>
              `;
            }
          }
        })
        .getSessionUser();

      // 翌月を設定
      const nextMonth = new Date();
      nextMonth.setMonth(nextMonth.getMonth() + 1);
      const yearMonth = nextMonth.getFullYear() + '-' + String(nextMonth.getMonth() + 1).padStart(2, '0');
      document.getElementById('targetMonth').value = yearMonth;
      if (document.getElementById('shiftTargetMonth')) {
        document.getElementById('shiftTargetMonth').value = yearMonth;
      }

      loadRequestData();
    };

    // ページ切り替え
    function showPage(pageName) {
      // 全てのページを非表示
      document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));

      // 選択されたページを表示
      document.getElementById('page' + pageName.charAt(0).toUpperCase() + pageName.slice(1)).classList.remove('hidden');

      // マスタ管理ページの場合、初期タブを表示
      if (pageName === 'master') {
        showMasterTab('event');
      }
    }

    // マスタ管理タブ切り替え
    function showMasterTab(tabName) {
      document.querySelectorAll('[id^="tab"]').forEach(el => {
        el.classList.remove('border-b-2', 'border-blue-600', 'text-blue-600');
        el.classList.add('text-gray-600');
      });

      const tabButton = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
      if (tabButton) {
        tabButton.classList.add('border-b-2', 'border-blue-600', 'text-blue-600');
        tabButton.classList.remove('text-gray-600');
      }

      // タブに応じたコンテンツを読み込み
      loadMasterContent(tabName);
    }

    // マスタコンテンツ読み込み
    function loadMasterContent(tabName) {
      const content = document.getElementById('masterContent');

      switch(tabName) {
        case 'event':
          loadEventManagement();
          break;
        case 'staff':
          loadStaffManagement();
          break;
        case 'shift':
          loadShiftManagement();
          break;
        case 'rule':
          loadRuleManagement();
          break;
        default:
          content.innerHTML = '<p class="text-gray-500 text-center">マスタ管理機能は開発中です</p>';
      }
    }

    // イベント管理画面の読み込み
    function loadEventManagement() {
      const content = document.getElementById('masterContent');
      content.innerHTML = `
        <div class="space-y-6">
          <!-- イベント登録フォーム -->
          <div class="border-b pb-6">
            <h3 class="text-lg font-bold mb-4">イベント登録</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">イベント日</label>
                <input
                  type="date"
                  id="eventDate"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ユニット（任意）</label>
                <input
                  type="text"
                  id="eventUnit"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="ユニット名"
                >
              </div>

              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">対象グループ</label>
                <div class="grid grid-cols-6 gap-2">
                  <label class="flex items-center space-x-1">
                    <input type="checkbox" name="eventGroups" value="1" class="rounded">
                    <span class="text-sm">グループ1</span>
                  </label>
                  <label class="flex items-center space-x-1">
                    <input type="checkbox" name="eventGroups" value="2" class="rounded">
                    <span class="text-sm">グループ2</span>
                  </label>
                  <label class="flex items-center space-x-1">
                    <input type="checkbox" name="eventGroups" value="3" class="rounded">
                    <span class="text-sm">グループ3</span>
                  </label>
                  <label class="flex items-center space-x-1">
                    <input type="checkbox" name="eventGroups" value="4" class="rounded">
                    <span class="text-sm">グループ4</span>
                  </label>
                  <label class="flex items-center space-x-1">
                    <input type="checkbox" name="eventGroups" value="5" class="rounded">
                    <span class="text-sm">グループ5</span>
                  </label>
                  <label class="flex items-center space-x-1">
                    <input type="checkbox" name="eventGroups" value="6" class="rounded">
                    <span class="text-sm">グループ6</span>
                  </label>
                </div>
              </div>

              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">内容</label>
                <textarea
                  id="eventContent"
                  rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="イベントの内容を入力してください"
                ></textarea>
              </div>
            </div>

            <div class="mt-4 flex space-x-2">
              <button
                onclick="saveNewEvent()"
                class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-medium"
              >
                登録
              </button>
              <button
                onclick="clearEventForm()"
                class="bg-gray-400 text-white px-6 py-2 rounded hover:bg-gray-500"
              >
                クリア
              </button>
            </div>
          </div>

          <!-- イベント一覧 -->
          <div>
            <h3 class="text-lg font-bold mb-4">イベント一覧</h3>
            <div id="eventTableContainer">
              <p class="text-gray-500 text-center py-4">読み込み中...</p>
            </div>
          </div>
        </div>
      `;

      // イベント一覧を読み込み
      loadAllEvents();
    }

    // 全イベント読み込み
    function loadAllEvents() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            renderEventTable(result.data);
          } else {
            document.getElementById('eventTableContainer').innerHTML =
              '<p class="text-red-500">エラー: ' + result.error + '</p>';
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('eventTableContainer').innerHTML =
            '<p class="text-red-500">読み込みエラー: ' + error.message + '</p>';
        })
        .getAllEventsForAdmin();
    }

    // イベント一覧表示
    function renderEventTable(events) {
      const container = document.getElementById('eventTableContainer');

      if (events.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">登録されているイベントはありません</p>';
        return;
      }

      let html = '<table class="min-w-full border-collapse border border-gray-300">';
      html += '<thead><tr class="bg-gray-100">';
      html += '<th class="border border-gray-300 p-2 text-left">イベント日</th>';
      html += '<th class="border border-gray-300 p-2 text-left">内容</th>';
      html += '<th class="border border-gray-300 p-2 text-left">グループ</th>';
      html += '<th class="border border-gray-300 p-2 text-left">ユニット</th>';
      html += '<th class="border border-gray-300 p-2 text-left">登録者</th>';
      html += '<th class="border border-gray-300 p-2 text-center">操作</th>';
      html += '</tr></thead><tbody>';

      events.forEach(event => {
        html += '<tr>';
        html += `<td class="border border-gray-300 p-2">${event.eventDate}</td>`;
        html += `<td class="border border-gray-300 p-2">${event.content}</td>`;
        html += `<td class="border border-gray-300 p-2">${event.groups.join(', ')}</td>`;
        html += `<td class="border border-gray-300 p-2">${event.unit || '-'}</td>`;
        html += `<td class="border border-gray-300 p-2">${event.registeredBy}</td>`;
        html += `<td class="border border-gray-300 p-2 text-center">
          <button onclick='editEvent(${JSON.stringify(event)})'
            class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 mr-1">
            編集
          </button>
          <button onclick="deleteEventConfirm('${event.eventId}')"
            class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
            削除
          </button>
        </td>`;
        html += '</tr>';
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // イベント登録フォームをクリア
    function clearEventForm() {
      document.getElementById('eventDate').value = '';
      document.getElementById('eventUnit').value = '';
      document.getElementById('eventContent').value = '';
      document.querySelectorAll('input[name="eventGroups"]').forEach(cb => cb.checked = false);

      // 編集モード解除
      const saveButton = document.querySelector('button[onclick="saveNewEvent()"]');
      if (saveButton) {
        saveButton.textContent = '登録';
        saveButton.onclick = saveNewEvent;
      }
    }

    // 新規イベント保存
    function saveNewEvent() {
      const eventDate = document.getElementById('eventDate').value;
      const unit = document.getElementById('eventUnit').value;
      const content = document.getElementById('eventContent').value;
      const groups = Array.from(document.querySelectorAll('input[name="eventGroups"]:checked'))
        .map(cb => cb.value).join(',');

      if (!eventDate || !content) {
        showMessage('イベント日と内容を入力してください', 'warning');
        return;
      }

      // YYYY/MM/DD形式に変換
      const dateObj = new Date(eventDate);
      const formattedDate = formatDate(dateObj);

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage('イベントを登録しました', 'success');
            clearEventForm();
            loadAllEvents();
          } else {
            showMessage('エラー: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('通信エラー: ' + error.message, 'error');
        })
        .saveEvent(formattedDate, groups, unit, content);
    }

    // イベント編集
    let editingEventId = null;

    function editEvent(event) {
      editingEventId = event.eventId;

      // フォームに値をセット
      const dateObj = new Date(event.eventDate);
      document.getElementById('eventDate').value = dateObj.toISOString().split('T')[0];
      document.getElementById('eventUnit').value = event.unit || '';
      document.getElementById('eventContent').value = event.content;

      // グループチェックボックスをセット
      document.querySelectorAll('input[name="eventGroups"]').forEach(cb => {
        cb.checked = event.groups.includes(cb.value);
      });

      // ボタンを更新モードに変更
      const saveButton = document.querySelector('button[onclick="saveNewEvent()"]');
      if (saveButton) {
        saveButton.textContent = '更新';
        saveButton.onclick = function() { updateEventData(); };
      }

      // フォームまでスクロール
      document.getElementById('masterContent').scrollTop = 0;
      showMessage('編集モードです。更新ボタンを押して保存してください', 'info');
    }

    // イベント更新
    function updateEventData() {
      if (!editingEventId) {
        showMessage('編集対象が選択されていません', 'error');
        return;
      }

      const eventDate = document.getElementById('eventDate').value;
      const unit = document.getElementById('eventUnit').value;
      const content = document.getElementById('eventContent').value;
      const groups = Array.from(document.querySelectorAll('input[name="eventGroups"]:checked'))
        .map(cb => cb.value).join(',');

      if (!eventDate || !content) {
        showMessage('イベント日と内容を入力してください', 'warning');
        return;
      }

      // YYYY/MM/DD形式に変換
      const dateObj = new Date(eventDate);
      const formattedDate = formatDate(dateObj);

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage('イベントを更新しました', 'success');
            editingEventId = null;
            clearEventForm();
            loadAllEvents();

            // ボタンを登録モードに戻す
            const saveButton = document.querySelector('button[onclick^="updateEventData"]');
            if (saveButton) {
              saveButton.textContent = '登録';
              saveButton.onclick = saveNewEvent;
            }
          } else {
            showMessage('エラー: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('通信エラー: ' + error.message, 'error');
        })
        .updateEvent(editingEventId, formattedDate, groups, unit, content);
    }

    // イベント削除確認
    function deleteEventConfirm(eventId) {
      if (confirm('このイベントを削除しますか？')) {
        deleteEventData(eventId);
      }
    }

    // イベント削除
    function deleteEventData(eventId) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage('イベントを削除しました', 'success');
            loadAllEvents();
          } else {
            showMessage('エラー: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('通信エラー: ' + error.message, 'error');
        })
        .deleteEvent(eventId);
    }

    // ====================
    // 職員マスタ管理
    // ====================

    let editingStaffId = null;

    // 職員マスタ管理画面の読み込み
    function loadStaffManagement() {
      const content = document.getElementById('masterContent');
      content.innerHTML = `
        <div class="space-y-6">
          <!-- 職員登録フォーム -->
          <div class="border-b pb-6">
            <h3 class="text-lg font-bold mb-4">職員登録</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">氏名 <span class="text-red-500">*</span></label>
                <input type="text" id="staffName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="山田太郎">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">所属</label>
                <input type="text" id="staffDepartment" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="介護部">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">役職</label>
                <input type="text" id="staffPosition" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="介護職員">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ユニット</label>
                <input type="text" id="staffUnit" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="A">
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">グループ</label>
                <div class="grid grid-cols-6 gap-2">
                  <label class="flex items-center space-x-1">
                    <input type="checkbox" name="staffGroups" value="1" class="rounded">
                    <span class="text-sm">グループ1</span>
                  </label>
                  <label class="flex items-center space-x-1">
                    <input type="checkbox" name="staffGroups" value="2" class="rounded">
                    <span class="text-sm">グループ2</span>
                  </label>
                  <label class="flex items-center space-x-1">
                    <input type="checkbox" name="staffGroups" value="3" class="rounded">
                    <span class="text-sm">グループ3</span>
                  </label>
                  <label class="flex items-center space-x-1">
                    <input type="checkbox" name="staffGroups" value="4" class="rounded">
                    <span class="text-sm">グループ4</span>
                  </label>
                  <label class="flex items-center space-x-1">
                    <input type="checkbox" name="staffGroups" value="5" class="rounded">
                    <span class="text-sm">グループ5</span>
                  </label>
                  <label class="flex items-center space-x-1">
                    <input type="checkbox" name="staffGroups" value="6" class="rounded">
                    <span class="text-sm">グループ6</span>
                  </label>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">権限</label>
                <select id="staffRole" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="一般">一般</option>
                  <option value="管理者">管理者</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">雇用形態</label>
                <select id="staffEmploymentType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="常勤">常勤</option>
                  <option value="派遣">派遣</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">勤務配慮</label>
                <input type="text" id="staffWorkConsiderations" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="特になし">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">パスワード</label>
                <input type="password" id="staffPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="password123">
              </div>
              <div class="flex items-center space-x-4">
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="staffIsSuctionCertified" class="rounded">
                  <span class="text-sm">喀痰吸引資格者</span>
                </label>
                <label class="flex items-center space-x-2">
                  <input type="checkbox" id="staffIsActive" class="rounded" checked>
                  <span class="text-sm">有効</span>
                </label>
              </div>
            </div>
            <div class="mt-4 flex space-x-2">
              <button onclick="saveNewStaff()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-medium">登録</button>
              <button onclick="clearStaffForm()" class="bg-gray-400 text-white px-6 py-2 rounded hover:bg-gray-500">クリア</button>
            </div>
          </div>
          <!-- 職員一覧 -->
          <div>
            <h3 class="text-lg font-bold mb-4">職員一覧</h3>
            <div id="staffTableContainer">
              <p class="text-gray-500 text-center py-4">読み込み中...</p>
            </div>
          </div>
        </div>
      `;
      loadAllStaffs();
    }

    // 全職員読み込み
    function loadAllStaffs() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            renderStaffTable(result.data);
          } else {
            document.getElementById('staffTableContainer').innerHTML = '<p class="text-red-500">エラー: ' + result.error + '</p>';
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('staffTableContainer').innerHTML = '<p class="text-red-500">読み込みエラー: ' + error.message + '</p>';
        })
        .getAllStaffsForAdmin();
    }

    // 職員一覧表示
    function renderStaffTable(staffs) {
      const container = document.getElementById('staffTableContainer');
      if (staffs.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">登録されている職員はいません</p>';
        return;
      }
      let html = '<div class="overflow-x-auto"><table class="min-w-full border-collapse border border-gray-300 text-sm">';
      html += '<thead><tr class="bg-gray-100">';
      html += '<th class="border border-gray-300 p-2 text-left">氏名</th>';
      html += '<th class="border border-gray-300 p-2 text-left">所属</th>';
      html += '<th class="border border-gray-300 p-2 text-left">役職</th>';
      html += '<th class="border border-gray-300 p-2 text-left">グループ</th>';
      html += '<th class="border border-gray-300 p-2 text-left">ユニット</th>';
      html += '<th class="border border-gray-300 p-2 text-left">権限</th>';
      html += '<th class="border border-gray-300 p-2 text-left">雇用形態</th>';
      html += '<th class="border border-gray-300 p-2 text-center">有効</th>';
      html += '<th class="border border-gray-300 p-2 text-center">操作</th>';
      html += '</tr></thead><tbody>';
      staffs.forEach(staff => {
        html += '<tr>';
        html += `<td class="border border-gray-300 p-2">${staff.name}</td>`;
        html += `<td class="border border-gray-300 p-2">${staff.department || '-'}</td>`;
        html += `<td class="border border-gray-300 p-2">${staff.position || '-'}</td>`;
        html += `<td class="border border-gray-300 p-2">${staff.groups.join(', ') || '-'}</td>`;
        html += `<td class="border border-gray-300 p-2">${staff.unit || '-'}</td>`;
        html += `<td class="border border-gray-300 p-2">${staff.role}</td>`;
        html += `<td class="border border-gray-300 p-2">${staff.employmentType}</td>`;
        html += `<td class="border border-gray-300 p-2 text-center">${staff.isActive ? '✓' : '✗'}</td>`;
        html += `<td class="border border-gray-300 p-2 text-center">
          <button onclick='editStaff(${JSON.stringify(staff)})' class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 mr-1">編集</button>
          <button onclick="deleteStaffConfirm('${staff.staffId}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">削除</button>
        </td>`;
        html += '</tr>';
      });
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    // 職員登録フォームをクリア
    function clearStaffForm() {
      document.getElementById('staffName').value = '';
      document.getElementById('staffDepartment').value = '';
      document.getElementById('staffPosition').value = '';
      document.getElementById('staffUnit').value = '';
      document.getElementById('staffRole').value = '一般';
      document.getElementById('staffEmploymentType').value = '常勤';
      document.getElementById('staffWorkConsiderations').value = '';
      document.getElementById('staffPassword').value = '';
      document.getElementById('staffIsSuctionCertified').checked = false;
      document.getElementById('staffIsActive').checked = true;
      document.querySelectorAll('input[name="staffGroups"]').forEach(cb => cb.checked = false);
      editingStaffId = null;
      const saveButton = document.querySelector('button[onclick="saveNewStaff()"]');
      if (saveButton) {
        saveButton.textContent = '登録';
        saveButton.onclick = saveNewStaff;
      }
    }

    // 新規職員保存
    function saveNewStaff() {
      const name = document.getElementById('staffName').value;
      const department = document.getElementById('staffDepartment').value;
      const position = document.getElementById('staffPosition').value;
      const unit = document.getElementById('staffUnit').value;
      const role = document.getElementById('staffRole').value;
      const employmentType = document.getElementById('staffEmploymentType').value;
      const workConsiderations = document.getElementById('staffWorkConsiderations').value;
      const password = document.getElementById('staffPassword').value;
      const isSuctionCertified = document.getElementById('staffIsSuctionCertified').checked;
      const isActive = document.getElementById('staffIsActive').checked;
      const groups = Array.from(document.querySelectorAll('input[name="staffGroups"]:checked')).map(cb => cb.value).join(',');

      if (!name) {
        showMessage('氏名を入力してください', 'warning');
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage('職員を登録しました', 'success');
            clearStaffForm();
            loadAllStaffs();
          } else {
            showMessage('エラー: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('通信エラー: ' + error.message, 'error');
        })
        .saveStaff(department, position, groups, unit, name, isSuctionCertified, workConsiderations, role, employmentType, isActive, password);
    }

    // 職員編集
    function editStaff(staff) {
      editingStaffId = staff.staffId;
      document.getElementById('staffName').value = staff.name;
      document.getElementById('staffDepartment').value = staff.department || '';
      document.getElementById('staffPosition').value = staff.position || '';
      document.getElementById('staffUnit').value = staff.unit || '';
      document.getElementById('staffRole').value = staff.role;
      document.getElementById('staffEmploymentType').value = staff.employmentType;
      document.getElementById('staffWorkConsiderations').value = staff.workConsiderations || '';
      document.getElementById('staffPassword').value = '';
      document.getElementById('staffIsSuctionCertified').checked = staff.isSuctionCertified;
      document.getElementById('staffIsActive').checked = staff.isActive;
      document.querySelectorAll('input[name="staffGroups"]').forEach(cb => {
        cb.checked = staff.groups.includes(cb.value);
      });
      const saveButton = document.querySelector('button[onclick="saveNewStaff()"]');
      if (saveButton) {
        saveButton.textContent = '更新';
        saveButton.onclick = function() { updateStaffData(); };
      }
      document.getElementById('masterContent').scrollTop = 0;
      showMessage('編集モードです。更新ボタンを押して保存してください', 'info');
    }

    // 職員更新
    function updateStaffData() {
      if (!editingStaffId) {
        showMessage('編集対象が選択されていません', 'error');
        return;
      }
      const name = document.getElementById('staffName').value;
      const department = document.getElementById('staffDepartment').value;
      const position = document.getElementById('staffPosition').value;
      const unit = document.getElementById('staffUnit').value;
      const role = document.getElementById('staffRole').value;
      const employmentType = document.getElementById('staffEmploymentType').value;
      const workConsiderations = document.getElementById('staffWorkConsiderations').value;
      const password = document.getElementById('staffPassword').value;
      const isSuctionCertified = document.getElementById('staffIsSuctionCertified').checked;
      const isActive = document.getElementById('staffIsActive').checked;
      const groups = Array.from(document.querySelectorAll('input[name="staffGroups"]:checked')).map(cb => cb.value).join(',');

      if (!name) {
        showMessage('氏名を入力してください', 'warning');
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage('職員を更新しました', 'success');
            clearStaffForm();
            loadAllStaffs();
          } else {
            showMessage('エラー: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('通信エラー: ' + error.message, 'error');
        })
        .updateStaff(editingStaffId, department, position, groups, unit, name, isSuctionCertified, workConsiderations, role, employmentType, isActive, password);
    }

    // 職員削除確認
    function deleteStaffConfirm(staffId) {
      if (confirm('この職員を削除（無効化）しますか？')) {
        deleteStaffData(staffId);
      }
    }

    // 職員削除
    function deleteStaffData(staffId) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage('職員を削除しました', 'success');
            loadAllStaffs();
          } else {
            showMessage('エラー: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('通信エラー: ' + error.message, 'error');
        })
        .deleteStaff(staffId);
    }

    // ====================
    // シフトマスタ管理
    // ====================

    let editingShiftId = null;

    // シフトマスタ管理画面の読み込み
    function loadShiftManagement() {
      const content = document.getElementById('masterContent');
      content.innerHTML = `
        <div class="space-y-6">
          <!-- シフト登録フォーム -->
          <div class="border-b pb-6">
            <h3 class="text-lg font-bold mb-4">シフト登録</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">シフト名 <span class="text-red-500">*</span></label>
                <input type="text" id="shiftName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="早出">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">開始時間</label>
                <input type="time" id="shiftStartTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">終了時間</label>
                <input type="time" id="shiftEndTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>
            <div class="mt-4 flex space-x-2">
              <button onclick="saveNewShift()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-medium">登録</button>
              <button onclick="clearShiftForm()" class="bg-gray-400 text-white px-6 py-2 rounded hover:bg-gray-500">クリア</button>
            </div>
          </div>
          <!-- シフト一覧 -->
          <div>
            <h3 class="text-lg font-bold mb-4">シフト一覧</h3>
            <div id="shiftTableContainer">
              <p class="text-gray-500 text-center py-4">読み込み中...</p>
            </div>
          </div>
        </div>
      `;
      loadAllShifts();
    }

    // 全シフト読み込み
    function loadAllShifts() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            renderShiftTable(result.data);
          } else {
            document.getElementById('shiftTableContainer').innerHTML = '<p class="text-red-500">エラー: ' + result.error + '</p>';
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('shiftTableContainer').innerHTML = '<p class="text-red-500">読み込みエラー: ' + error.message + '</p>';
        })
        .getAllShiftsForAdmin();
    }

    // シフト一覧表示
    function renderShiftTable(shifts) {
      const container = document.getElementById('shiftTableContainer');
      if (shifts.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">登録されているシフトはありません</p>';
        return;
      }
      let html = '<table class="min-w-full border-collapse border border-gray-300">';
      html += '<thead><tr class="bg-gray-100">';
      html += '<th class="border border-gray-300 p-2 text-left">シフト名</th>';
      html += '<th class="border border-gray-300 p-2 text-left">開始時間</th>';
      html += '<th class="border border-gray-300 p-2 text-left">終了時間</th>';
      html += '<th class="border border-gray-300 p-2 text-center">操作</th>';
      html += '</tr></thead><tbody>';
      shifts.forEach(shift => {
        html += '<tr>';
        html += `<td class="border border-gray-300 p-2">${shift.name}</td>`;
        html += `<td class="border border-gray-300 p-2">${shift.startTime || '-'}</td>`;
        html += `<td class="border border-gray-300 p-2">${shift.endTime || '-'}</td>`;
        html += `<td class="border border-gray-300 p-2 text-center">
          <button onclick='editShift(${JSON.stringify(shift)})' class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 mr-1">編集</button>
          <button onclick="deleteShiftConfirm('${shift.shiftId}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">削除</button>
        </td>`;
        html += '</tr>';
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // シフト登録フォームをクリア
    function clearShiftForm() {
      document.getElementById('shiftName').value = '';
      document.getElementById('shiftStartTime').value = '';
      document.getElementById('shiftEndTime').value = '';
      editingShiftId = null;
      const saveButton = document.querySelector('button[onclick="saveNewShift()"]');
      if (saveButton) {
        saveButton.textContent = '登録';
        saveButton.onclick = saveNewShift;
      }
    }

    // 新規シフト保存
    function saveNewShift() {
      const name = document.getElementById('shiftName').value;
      const startTime = document.getElementById('shiftStartTime').value;
      const endTime = document.getElementById('shiftEndTime').value;

      if (!name) {
        showMessage('シフト名を入力してください', 'warning');
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage('シフトを登録しました', 'success');
            clearShiftForm();
            loadAllShifts();
          } else {
            showMessage('エラー: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('通信エラー: ' + error.message, 'error');
        })
        .saveShift(name, startTime, endTime);
    }

    // シフト編集
    function editShift(shift) {
      editingShiftId = shift.shiftId;
      document.getElementById('shiftName').value = shift.name;
      document.getElementById('shiftStartTime').value = shift.startTime || '';
      document.getElementById('shiftEndTime').value = shift.endTime || '';
      const saveButton = document.querySelector('button[onclick="saveNewShift()"]');
      if (saveButton) {
        saveButton.textContent = '更新';
        saveButton.onclick = function() { updateShift(); };
      }
      document.getElementById('masterContent').scrollTop = 0;
      showMessage('編集モードです。更新ボタンを押して保存してください', 'info');
    }

    // シフト更新
    function updateShift() {
      if (!editingShiftId) {
        showMessage('編集対象が選択されていません', 'error');
        return;
      }
      const name = document.getElementById('shiftName').value;
      const startTime = document.getElementById('shiftStartTime').value;
      const endTime = document.getElementById('shiftEndTime').value;

      if (!name) {
        showMessage('シフト名を入力してください', 'warning');
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage('シフトを更新しました', 'success');
            clearShiftForm();
            loadAllShifts();
          } else {
            showMessage('エラー: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('通信エラー: ' + error.message, 'error');
        })
        .updateShiftData(editingShiftId, name, startTime, endTime);
    }

    // シフト削除確認
    function deleteShiftConfirm(shiftId) {
      if (confirm('このシフトを削除しますか？')) {
        deleteShift(shiftId);
      }
    }

    // シフト削除
    function deleteShift(shiftId) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage('シフトを削除しました', 'success');
            loadAllShifts();
          } else {
            showMessage('エラー: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('通信エラー: ' + error.message, 'error');
        })
        .deleteShiftData(shiftId);
    }

    // ====================
    // ルールマスタ管理
    // ====================

    let editingRuleId = null;

    // ルールマスタ管理画面の読み込み
    function loadRuleManagement() {
      const content = document.getElementById('masterContent');
      content.innerHTML = `
        <div class="space-y-6">
          <!-- ルール登録フォーム -->
          <div class="border-b pb-6">
            <h3 class="text-lg font-bold mb-4">ルール登録</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ルール名 <span class="text-red-500">*</span></label>
                <input type="text" id="ruleName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="夜勤は週2回まで">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">重要度</label>
                <select id="rulePriority" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="最高">最高</option>
                  <option value="高">高</option>
                  <option value="中" selected>中</option>
                  <option value="低">低</option>
                  <option value="最低">最低</option>
                </select>
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">内容 <span class="text-red-500">*</span></label>
                <textarea id="ruleContent" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="各職員の夜勤勤務は週に2回までとする。"></textarea>
              </div>
            </div>
            <div class="mt-4 flex space-x-2">
              <button onclick="saveNewRule()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-medium">登録</button>
              <button onclick="clearRuleForm()" class="bg-gray-400 text-white px-6 py-2 rounded hover:bg-gray-500">クリア</button>
            </div>
          </div>
          <!-- ルール一覧 -->
          <div>
            <h3 class="text-lg font-bold mb-4">ルール一覧</h3>
            <div id="ruleTableContainer">
              <p class="text-gray-500 text-center py-4">読み込み中...</p>
            </div>
          </div>
        </div>
      `;
      loadAllRules();
    }

    // 全ルール読み込み
    function loadAllRules() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            renderRuleTable(result.data);
          } else {
            document.getElementById('ruleTableContainer').innerHTML = '<p class="text-red-500">エラー: ' + result.error + '</p>';
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('ruleTableContainer').innerHTML = '<p class="text-red-500">読み込みエラー: ' + error.message + '</p>';
        })
        .getAllRulesForAdmin();
    }

    // ルール一覧表示
    function renderRuleTable(rules) {
      const container = document.getElementById('ruleTableContainer');
      if (rules.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">登録されているルールはありません</p>';
        return;
      }
      let html = '<table class="min-w-full border-collapse border border-gray-300">';
      html += '<thead><tr class="bg-gray-100">';
      html += '<th class="border border-gray-300 p-2 text-left">ルール名</th>';
      html += '<th class="border border-gray-300 p-2 text-left">内容</th>';
      html += '<th class="border border-gray-300 p-2 text-left">重要度</th>';
      html += '<th class="border border-gray-300 p-2 text-center">操作</th>';
      html += '</tr></thead><tbody>';
      rules.forEach(rule => {
        html += '<tr>';
        html += `<td class="border border-gray-300 p-2">${rule.name}</td>`;
        html += `<td class="border border-gray-300 p-2">${rule.content}</td>`;
        html += `<td class="border border-gray-300 p-2">${rule.priority}</td>`;
        html += `<td class="border border-gray-300 p-2 text-center">
          <button onclick='editRule(${JSON.stringify(rule)})' class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 mr-1">編集</button>
          <button onclick="deleteRuleConfirm('${rule.ruleId}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">削除</button>
        </td>`;
        html += '</tr>';
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // ルール登録フォームをクリア
    function clearRuleForm() {
      document.getElementById('ruleName').value = '';
      document.getElementById('ruleContent').value = '';
      document.getElementById('rulePriority').value = '中';
      editingRuleId = null;
      const saveButton = document.querySelector('button[onclick="saveNewRule()"]');
      if (saveButton) {
        saveButton.textContent = '登録';
        saveButton.onclick = saveNewRule;
      }
    }

    // 新規ルール保存
    function saveNewRule() {
      const name = document.getElementById('ruleName').value;
      const content = document.getElementById('ruleContent').value;
      const priority = document.getElementById('rulePriority').value;

      if (!name || !content) {
        showMessage('ルール名と内容を入力してください', 'warning');
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage('ルールを登録しました', 'success');
            clearRuleForm();
            loadAllRules();
          } else {
            showMessage('エラー: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('通信エラー: ' + error.message, 'error');
        })
        .saveRule(name, content, priority);
    }

    // ルール編集
    function editRule(rule) {
      editingRuleId = rule.ruleId;
      document.getElementById('ruleName').value = rule.name;
      document.getElementById('ruleContent').value = rule.content;
      document.getElementById('rulePriority').value = rule.priority;
      const saveButton = document.querySelector('button[onclick="saveNewRule()"]');
      if (saveButton) {
        saveButton.textContent = '更新';
        saveButton.onclick = function() { updateRule(); };
      }
      document.getElementById('masterContent').scrollTop = 0;
      showMessage('編集モードです。更新ボタンを押して保存してください', 'info');
    }

    // ルール更新
    function updateRule() {
      if (!editingRuleId) {
        showMessage('編集対象が選択されていません', 'error');
        return;
      }
      const name = document.getElementById('ruleName').value;
      const content = document.getElementById('ruleContent').value;
      const priority = document.getElementById('rulePriority').value;

      if (!name || !content) {
        showMessage('ルール名と内容を入力してください', 'warning');
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage('ルールを更新しました', 'success');
            clearRuleForm();
            loadAllRules();
          } else {
            showMessage('エラー: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('通信エラー: ' + error.message, 'error');
        })
        .updateRuleData(editingRuleId, name, content, priority);
    }

    // ルール削除確認
    function deleteRuleConfirm(ruleId) {
      if (confirm('このルールを削除しますか？')) {
        deleteRule(ruleId);
      }
    }

    // ルール削除
    function deleteRule(ruleId) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showMessage('ルールを削除しました', 'success');
            loadAllRules();
          } else {
            showMessage('エラー: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showMessage('通信エラー: ' + error.message, 'error');
        })
        .deleteRuleData(ruleId);
    }

    // ログアウト
    function logout() {
      if (confirm('ログアウトしますか？')) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              // スクリプトURLを取得してログイン画面に遷移
              google.script.run
                .withSuccessHandler(function(scriptUrl) {
                  window.top.location.href = scriptUrl + '?page=login';
                })
                .getScriptUrl();
            }
          })
          .logoutUser();
      }
    }

    // 休み希望データ読み込み
    async function loadRequestData() {
      const targetMonthInput = document.getElementById('targetMonth').value;
      currentMonth = targetMonthInput;

      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              selectedDates = new Set(result.data.dates);
              document.getElementById('notes').value = result.data.notes || '';
              renderCalendar();
            }
          })
          .getRequest(null, currentMonth);

        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              renderEvents(result.data);
            }
          })
          .getEvents('1,2,3,4,5,6', '', currentMonth);

      } catch (error) {
        showMessage('データの読み込みに失敗しました: ' + error, 'error');
      }
    }

    // カレンダー表示
    function renderCalendar() {
      if (!currentMonth) return;

      const [year, month] = currentMonth.split('-').map(Number);
      const firstDay = new Date(year, month - 1, 1);
      const daysInMonth = new Date(year, month, 0).getDate();
      const startDay = firstDay.getDay();

      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';

      const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
      weekdays.forEach((day, index) => {
        const header = document.createElement('div');
        header.className = 'text-center font-bold p-2 ' +
          (index === 0 ? 'text-red-600' : index === 6 ? 'text-blue-600' : '');
        header.textContent = day;
        calendar.appendChild(header);
      });

      for (let i = 0; i < startDay; i++) {
        const empty = document.createElement('div');
        calendar.appendChild(empty);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month - 1, day);
        const dateStr = formatDate(date);
        const weekday = date.getDay();

        const cell = document.createElement('div');
        cell.className = 'border rounded p-2 text-center cursor-pointer hover:bg-gray-100 ' +
          (selectedDates.has(dateStr) ? 'bg-blue-500 text-white hover:bg-blue-600' : '') +
          (weekday === 0 ? ' text-red-600' : weekday === 6 ? ' text-blue-600' : '');

        cell.textContent = day;
        cell.onclick = function() {
          if (selectedDates.has(dateStr)) {
            selectedDates.delete(dateStr);
          } else {
            selectedDates.add(dateStr);
          }
          renderCalendar();
        };

        calendar.appendChild(cell);
      }
    }

    // イベント表示
    function renderEvents(events) {
      const eventList = document.getElementById('eventList');
      eventList.innerHTML = '';

      if (events.length === 0) {
        eventList.innerHTML = '<p class="text-gray-500 text-sm">イベントはありません</p>';
        return;
      }

      events.forEach(event => {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'border-l-4 border-blue-500 bg-blue-50 p-3';
        eventDiv.innerHTML = `
          <div class="text-sm font-medium">${event.eventDate}</div>
          <div class="text-sm">${event.content}</div>
        `;
        eventList.appendChild(eventDiv);
      });
    }

    // 休み希望提出
    async function submitRequest() {
      if (selectedDates.size === 0) {
        showMessage('休み希望日を選択してください', 'warning');
        return;
      }

      const dates = Array.from(selectedDates);
      const notes = document.getElementById('notes').value;

      const data = {
        action: 'submitRequest',
        dates: JSON.stringify(dates),
        notes: notes
      };

      try {
        const response = await fetch(window.location.href, {
          method: 'POST',
          body: new URLSearchParams(data)
        });

        const result = await response.json();

        if (result.success) {
          showMessage('休み希望を提出しました', 'success');
        } else {
          showMessage('エラー: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('通信エラー: ' + error.message, 'error');
      }
    }

    // シフト生成（管理者のみ）
    async function generateShift() {
      const targetMonth = document.getElementById('shiftTargetMonth').value;
      const groups = Array.from(document.querySelectorAll('input[name="targetGroups"]:checked'))
        .map(cb => cb.value);

      if (groups.length === 0) {
        showMessage('グループを選択してください', 'warning');
        return;
      }

      if (!confirm(`${targetMonth} のシフトを生成しますか？\n（生成には数分かかる場合があります）`)) {
        return;
      }

      const data = {
        action: 'generateShift',
        yearMonth: targetMonth,
        groups: groups.join(',')
      };

      try {
        showMessage('シフトを生成中です... しばらくお待ちください', 'info');

        const response = await fetch(window.location.href, {
          method: 'POST',
          body: new URLSearchParams(data)
        });

        const result = await response.json();

        if (result.success) {
          currentTableId = result.data.tableId;
          currentShiftData = result.data.shifts;

          showMessage('シフト生成が完了しました', 'success');

          if (result.data.feedback && result.data.feedback !== '特になし') {
            document.getElementById('feedbackText').textContent = result.data.feedback;
            document.getElementById('feedback').classList.remove('hidden');
          }

          renderShiftTable(targetMonth, result.data.shifts);
          document.getElementById('exportButton').disabled = false;

        } else {
          showMessage('エラー: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('通信エラー: ' + error.message, 'error');
      }
    }

    // シフト表表示
    function renderShiftTable(yearMonth, shifts) {
      const [year, month] = yearMonth.split('-').map(Number);
      const daysInMonth = new Date(year, month, 0).getDate();

      const shiftByStaff = {};
      shifts.forEach(shift => {
        if (!shiftByStaff[shift.staffName]) {
          shiftByStaff[shift.staffName] = {};
        }
        shiftByStaff[shift.staffName][shift.date] = shift.shiftName;
      });

      const staffNames = Object.keys(shiftByStaff);

      let html = '<table class="min-w-full border-collapse border border-gray-300 text-sm">';
      html += '<thead><tr class="bg-gray-200"><th class="border border-gray-300 p-2">氏名</th>';

      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month - 1, day);
        const weekday = getJapaneseWeekday(date);
        const bgColor = weekday === '日' ? 'bg-red-100' : weekday === '土' ? 'bg-blue-100' : '';
        html += `<th class="border border-gray-300 p-1 ${bgColor}">${day}<br/>(${weekday})</th>`;
      }
      html += '</tr></thead><tbody>';

      staffNames.forEach(staffName => {
        html += `<tr><td class="border border-gray-300 p-2 font-medium">${staffName}</td>`;

        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month - 1, day);
          const dateKey = formatDate(date);
          const shiftName = shiftByStaff[staffName][dateKey] || '';

          html += `<td class="border border-gray-300 p-1">
            <select class="w-full text-xs" onchange="updateShift('${staffName}', '${dateKey}', this.value)">
              <option value="" ${shiftName === '' ? 'selected' : ''}></option>
              <option value="早出" ${shiftName === '早出' ? 'selected' : ''}>早出</option>
              <option value="日勤" ${shiftName === '日勤' ? 'selected' : ''}>日勤</option>
              <option value="遅出" ${shiftName === '遅出' ? 'selected' : ''}>遅出</option>
              <option value="夜勤" ${shiftName === '夜勤' ? 'selected' : ''}>夜勤</option>
              <option value="休み" ${shiftName === '休み' ? 'selected' : ''}>休み</option>
            </select>
          </td>`;
        }

        html += '</tr>';
      });
      html += '</tbody></table>';

      document.getElementById('shiftTableContainer').innerHTML = html;
    }

    function updateShift(staffName, date, shiftName) {
      const index = currentShiftData.findIndex(s => s.staffName === staffName && s.date === date);
      if (index >= 0) {
        currentShiftData[index].shiftName = shiftName;
      }
    }

    // PDF出力
    async function exportPdf() {
      if (!currentTableId) {
        showMessage('シフト表が生成されていません', 'warning');
        return;
      }

      if (!confirm('PDF出力しますか？')) {
        return;
      }

      const data = {
        action: 'exportPdf',
        tableId: currentTableId
      };

      try {
        showMessage('PDF出力中...', 'info');

        const response = await fetch(window.location.href, {
          method: 'POST',
          body: new URLSearchParams(data)
        });

        const result = await response.json();

        if (result.success) {
          showMessage('PDF出力が完了しました: ' + result.data.fileName, 'success');

          const link = document.createElement('a');
          link.href = result.data.filePath;
          link.target = '_blank';
          link.textContent = 'PDFを開く';
          link.className = 'text-blue-600 underline ml-2';

          const messageDiv = document.getElementById('message');
          messageDiv.appendChild(document.createElement('br'));
          messageDiv.appendChild(link);

        } else {
          showMessage('エラー: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('通信エラー: ' + error.message, 'error');
      }
    }

    // メッセージ表示
    function showMessage(text, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = text;
      messageDiv.className = type === 'success' ? 'bg-green-50 border border-green-200 text-green-700 p-4 rounded' :
                             type === 'warning' ? 'bg-yellow-50 border border-yellow-200 text-yellow-700 p-4 rounded' :
                             type === 'info' ? 'bg-blue-50 border border-blue-200 text-blue-700 p-4 rounded' :
                             'bg-red-50 border border-red-200 text-red-700 p-4 rounded';
      messageDiv.classList.remove('hidden');

      if (type === 'success' || type === 'error') {
        setTimeout(() => {
          messageDiv.classList.add('hidden');
        }, 5000);
      }
    }

    // ユーティリティ関数
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}/${month}/${day}`;
    }

    function getJapaneseWeekday(date) {
      const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
      return weekdays[date.getDay()];
    }
  </script>
</body>
</html>
