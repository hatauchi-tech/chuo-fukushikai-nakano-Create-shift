<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>休み希望提出 - AIシフト作成アプリ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- ヘッダー -->
  <header class="bg-blue-600 text-white p-4 shadow-md">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-xl font-bold">休み希望提出</h1>
      <div class="flex items-center space-x-4">
        <span id="userName" class="text-sm"></span>
        <button onclick="logout()" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded text-sm">
          ログアウト
        </button>
      </div>
    </div>
  </header>

  <!-- メインコンテンツ -->
  <main class="container mx-auto p-4 max-w-4xl">
    <!-- 説明 -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-lg font-bold mb-2">休み希望について</h2>
      <p class="text-sm text-gray-600">
        来月の休み希望日をカレンダーから選択してください。<br>
        選択した日付は青色で表示されます。もう一度クリックすると選択を解除できます。
      </p>
    </div>

    <!-- 年月選択 -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <div class="flex items-center space-x-4">
        <label class="text-sm font-medium text-gray-700">対象月</label>
        <input
          type="month"
          id="targetMonth"
          class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
        <button
          onclick="loadRequestData()"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
        >
          読み込み
        </button>
      </div>
    </div>

    <!-- カレンダー -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h3 class="text-lg font-bold mb-4">カレンダー</h3>
      <div id="calendar" class="grid grid-cols-7 gap-2">
        <!-- カレンダーはJSで動的に生成 -->
      </div>
    </div>

    <!-- イベント表示 -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h3 class="text-lg font-bold mb-4">イベント・お知らせ</h3>
      <div id="eventList" class="space-y-2">
        <!-- イベントはJSで動的に生成 -->
      </div>
    </div>

    <!-- 特記事項 -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-2">特記事項（任意）</label>
      <textarea
        id="notes"
        rows="3"
        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
        placeholder="その他の連絡事項があれば記入してください"
      ></textarea>
    </div>

    <!-- 提出ボタン -->
    <div class="flex justify-end space-x-4">
      <button
        onclick="submitRequest()"
        class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-medium"
      >
        休み希望を提出
      </button>
    </div>

    <!-- メッセージ -->
    <div id="message" class="hidden mt-4 p-4 rounded"></div>
  </main>

  <script>
    let selectedDates = new Set();
    let currentMonth = null;

    // 初期化
    window.onload = function() {
      // 翌月を設定
      const nextMonth = new Date();
      nextMonth.setMonth(nextMonth.getMonth() + 1);
      const yearMonth = nextMonth.getFullYear() + '-' + String(nextMonth.getMonth() + 1).padStart(2, '0');
      document.getElementById('targetMonth').value = yearMonth;

      loadRequestData();
    };

    async function loadRequestData() {
      const targetMonthInput = document.getElementById('targetMonth').value;
      currentMonth = targetMonthInput;

      try {
        // 既存の休み希望を取得
        const requestData = await google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              selectedDates = new Set(result.data.dates);
              document.getElementById('notes').value = result.data.notes || '';
              renderCalendar();
            }
          })
          .getRequest(null, currentMonth);

        // イベントを取得
        // TODO: グループとユニットの取得
        const eventsData = await google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              renderEvents(result.data);
            }
          })
          .getEvents('1,2,3,4,5,6', '', currentMonth);

      } catch (error) {
        showMessage('データの読み込みに失敗しました: ' + error, 'error');
      }
    }

    function renderCalendar() {
      if (!currentMonth) return;

      const [year, month] = currentMonth.split('-').map(Number);
      const firstDay = new Date(year, month - 1, 1);
      const daysInMonth = new Date(year, month, 0).getDate();
      const startDay = firstDay.getDay();

      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';

      // 曜日ヘッダー
      const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
      weekdays.forEach((day, index) => {
        const header = document.createElement('div');
        header.className = 'text-center font-bold p-2 ' +
          (index === 0 ? 'text-red-600' : index === 6 ? 'text-blue-600' : '');
        header.textContent = day;
        calendar.appendChild(header);
      });

      // 空白セル
      for (let i = 0; i < startDay; i++) {
        const empty = document.createElement('div');
        calendar.appendChild(empty);
      }

      // 日付セル
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month - 1, day);
        const dateStr = formatDate(date);
        const weekday = date.getDay();

        const cell = document.createElement('div');
        cell.className = 'border rounded p-2 text-center cursor-pointer hover:bg-gray-100 ' +
          (selectedDates.has(dateStr) ? 'bg-blue-500 text-white hover:bg-blue-600' : '') +
          (weekday === 0 ? ' text-red-600' : weekday === 6 ? ' text-blue-600' : '');

        cell.textContent = day;
        cell.onclick = function() {
          if (selectedDates.has(dateStr)) {
            selectedDates.delete(dateStr);
          } else {
            selectedDates.add(dateStr);
          }
          renderCalendar();
        };

        calendar.appendChild(cell);
      }
    }

    function renderEvents(events) {
      const eventList = document.getElementById('eventList');
      eventList.innerHTML = '';

      if (events.length === 0) {
        eventList.innerHTML = '<p class="text-gray-500 text-sm">イベントはありません</p>';
        return;
      }

      events.forEach(event => {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'border-l-4 border-blue-500 bg-blue-50 p-3';
        eventDiv.innerHTML = `
          <div class="text-sm font-medium">${event.eventDate}</div>
          <div class="text-sm">${event.content}</div>
        `;
        eventList.appendChild(eventDiv);
      });
    }

    async function submitRequest() {
      if (selectedDates.size === 0) {
        showMessage('休み希望日を選択してください', 'warning');
        return;
      }

      const dates = Array.from(selectedDates);
      const notes = document.getElementById('notes').value;

      const data = {
        action: 'submitRequest',
        dates: JSON.stringify(dates),
        notes: notes
      };

      try {
        const response = await fetch(window.location.href, {
          method: 'POST',
          body: new URLSearchParams(data)
        });

        const result = await response.json();

        if (result.success) {
          showMessage('休み希望を提出しました', 'success');
        } else {
          showMessage('エラー: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('通信エラー: ' + error.message, 'error');
      }
    }

    function logout() {
      if (confirm('ログアウトしますか？')) {
        window.location.href = '?page=login';
      }
    }

    function showMessage(text, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = text;
      messageDiv.className = type === 'success' ? 'bg-green-50 border border-green-200 text-green-700 p-4 rounded' :
                             type === 'warning' ? 'bg-yellow-50 border border-yellow-200 text-yellow-700 p-4 rounded' :
                             'bg-red-50 border border-red-200 text-red-700 p-4 rounded';
      messageDiv.classList.remove('hidden');

      setTimeout(() => {
        messageDiv.classList.add('hidden');
      }, 5000);
    }

    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}/${month}/${day}`;
    }
  </script>
</body>
</html>
