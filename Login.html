<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ログイン - AIシフト作成アプリ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md">
    <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">AIシフト作成アプリ</h1>

    <form id="loginForm" class="space-y-4">
      <!-- グループ選択 -->
      <div>
        <label for="group" class="block text-sm font-medium text-gray-700 mb-2">
          所属グループ
        </label>
        <select
          id="group"
          name="group"
          required
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          onchange="loadStaffNames()"
        >
          <option value="">グループを選択してください</option>
          <option value="1">グループ1</option>
          <option value="2">グループ2</option>
          <option value="3">グループ3</option>
          <option value="4">グループ4</option>
          <option value="5">グループ5</option>
          <option value="6">グループ6</option>
        </select>
      </div>

      <!-- 氏名選択 -->
      <div>
        <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
          氏名
        </label>
        <select
          id="name"
          name="name"
          required
          disabled
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed"
        >
          <option value="">グループを選択してください</option>
        </select>
      </div>

      <!-- パスワード入力 -->
      <div>
        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
          パスワード
        </label>
        <input
          type="password"
          id="password"
          name="password"
          required
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="パスワード"
        >
      </div>

      <!-- エラーメッセージ -->
      <div id="errorMessage" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
      </div>

      <!-- ログインボタン -->
      <button
        type="submit"
        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
      >
        ログイン
      </button>
    </form>
  </div>

  <script>
    // グループ選択時に職員名リストを読み込む
    function loadStaffNames() {
      const groupSelect = document.getElementById('group');
      const nameSelect = document.getElementById('name');
      const selectedGroup = groupSelect.value;

      // 氏名選択をリセット
      nameSelect.innerHTML = '<option value="">読み込み中...</option>';
      nameSelect.disabled = true;

      if (!selectedGroup) {
        nameSelect.innerHTML = '<option value="">グループを選択してください</option>';
        return;
      }

      // GAS側の関数を呼び出して職員名リストを取得
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success && result.data) {
            nameSelect.innerHTML = '<option value="">職員を選択してください</option>';
            result.data.forEach(function(staffName) {
              const option = document.createElement('option');
              option.value = staffName;
              option.textContent = staffName;
              nameSelect.appendChild(option);
            });
            nameSelect.disabled = false;
          } else {
            nameSelect.innerHTML = '<option value="">エラー: ' + (result.error || '不明') + '</option>';
          }
        })
        .withFailureHandler(function(error) {
          nameSelect.innerHTML = '<option value="">エラー: ' + error.message + '</option>';
        })
        .getStaffNamesByGroup(selectedGroup);
    }

    // ログインフォーム送信
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const formData = new FormData(e.target);
      const group = formData.get('group');
      const name = formData.get('name');
      const password = formData.get('password');

      showLoading(true);

      // GAS側のauthenticateUser関数を呼び出し
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // ログイン成功 - ページ遷移
            // 管理者の場合はリーダー画面、一般の場合はスタッフ画面へ
            const redirectPage = result.data.role === '管理者' ? 'leader' : 'staff';
            window.location.href = '?page=' + redirectPage;
          } else {
            showLoading(false);
            showError(result.error);
          }
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showError('通信エラーが発生しました: ' + error.message);
        })
        .authenticateUser(group, name, password);
    });

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
    }

    function showLoading(isLoading) {
      const button = document.querySelector('button[type="submit"]');
      button.disabled = isLoading;
      button.textContent = isLoading ? 'ログイン中...' : 'ログイン';
    }
  </script>
</body>
</html>
