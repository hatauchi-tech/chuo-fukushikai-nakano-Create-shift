<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>シフト管理 - AIシフト作成アプリ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- ヘッダー -->
  <header class="bg-blue-600 text-white p-4 shadow-md">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-xl font-bold">シフト管理（リーダー）</h1>
      <div class="flex items-center space-x-4">
        <button onclick="showPage('master')" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded text-sm">
          マスタ管理
        </button>
        <span id="userName" class="text-sm"></span>
        <button onclick="logout()" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded text-sm">
          ログアウト
        </button>
      </div>
    </div>
  </header>

  <!-- メインコンテンツ -->
  <main class="container mx-auto p-4">
    <!-- シフト生成セクション -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-lg font-bold mb-4">シフト自動生成</h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <!-- 年月選択 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">対象月</label>
          <input
            type="month"
            id="targetMonth"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
        </div>

        <!-- グループ選択 -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">対象グループ</label>
          <div class="grid grid-cols-3 gap-2">
            <label class="flex items-center space-x-1">
              <input type="checkbox" name="targetGroups" value="1" class="rounded">
              <span class="text-sm">G1</span>
            </label>
            <label class="flex items-center space-x-1">
              <input type="checkbox" name="targetGroups" value="2" class="rounded">
              <span class="text-sm">G2</span>
            </label>
            <label class="flex items-center space-x-1">
              <input type="checkbox" name="targetGroups" value="3" class="rounded">
              <span class="text-sm">G3</span>
            </label>
            <label class="flex items-center space-x-1">
              <input type="checkbox" name="targetGroups" value="4" class="rounded">
              <span class="text-sm">G4</span>
            </label>
            <label class="flex items-center space-x-1">
              <input type="checkbox" name="targetGroups" value="5" class="rounded">
              <span class="text-sm">G5</span>
            </label>
            <label class="flex items-center space-x-1">
              <input type="checkbox" name="targetGroups" value="6" class="rounded">
              <span class="text-sm">G6</span>
            </label>
          </div>
        </div>

        <!-- 生成ボタン -->
        <div class="flex items-end">
          <button
            onclick="generateShift()"
            class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-medium"
          >
            シフト自動生成
          </button>
        </div>
      </div>

      <!-- フィードバック表示 -->
      <div id="feedback" class="hidden bg-yellow-50 border border-yellow-200 p-4 rounded">
        <h3 class="font-bold text-sm mb-2">AIフィードバック</h3>
        <p id="feedbackText" class="text-sm"></p>
      </div>
    </div>

    <!-- シフト表示・編集セクション -->
    <div id="shiftSection" class="bg-white rounded-lg shadow p-6 mb-6 hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">シフト表（確認・編集）</h2>
        <div class="space-x-2">
          <button
            onclick="confirmShift()"
            id="confirmButton"
            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-medium"
          >
            シフトを確定
          </button>
          <button
            onclick="exportPdf()"
            id="exportButton"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
            disabled
          >
            PDF出力
          </button>
        </div>
      </div>

      <div id="shiftTableContainer" class="overflow-x-auto">
        <!-- シフト表がここに動的に生成されます -->
      </div>
    </div>

    <!-- メッセージ -->
    <div id="message" class="hidden p-4 rounded"></div>
  </main>

  <script>
    let currentTableId = null;
    let currentShiftData = [];
    let currentStaffsInfo = [];
    let currentRequestDates = {};
    let currentYearMonth = '';
    let currentGroups = [];

    // 初期化
    window.onload = function() {
      // 翌月を設定
      const nextMonth = new Date();
      nextMonth.setMonth(nextMonth.getMonth() + 1);
      const yearMonth = nextMonth.getFullYear() + '-' + String(nextMonth.getMonth() + 1).padStart(2, '0');
      document.getElementById('targetMonth').value = yearMonth;
    };

    async function generateShift() {
      const targetMonth = document.getElementById('targetMonth').value;
      const groups = Array.from(document.querySelectorAll('input[name="targetGroups"]:checked'))
        .map(cb => cb.value);

      if (groups.length === 0) {
        showMessage('グループを選択してください', 'warning');
        return;
      }

      if (!confirm(`${targetMonth} のシフトを生成しますか？\n（生成には数分かかる場合があります）`)) {
        return;
      }

      const data = {
        action: 'generateShift',
        yearMonth: targetMonth,
        groups: groups.join(',')
      };

      try {
        showMessage('シフトを生成中です... しばらくお待ちください', 'info');

        const response = await fetch(window.location.href, {
          method: 'POST',
          body: new URLSearchParams(data)
        });

        const result = await response.json();

        if (result.success) {
          // データを保持
          currentShiftData = result.data.shifts;
          currentStaffsInfo = result.data.staffs;
          currentRequestDates = result.data.requestDates;
          currentYearMonth = result.data.yearMonth;
          currentGroups = result.data.groups;

          showMessage('シフト生成が完了しました。内容を確認してください。', 'success');

          // フィードバック表示
          if (result.data.feedback && result.data.feedback !== '特になし') {
            document.getElementById('feedbackText').textContent = result.data.feedback;
            document.getElementById('feedback').classList.remove('hidden');
          } else {
            document.getElementById('feedback').classList.add('hidden');
          }

          // シフト表を表示
          renderShiftTable(targetMonth, result.data.shifts, result.data.staffs, result.data.requestDates);

          // シフトセクションを表示
          document.getElementById('shiftSection').classList.remove('hidden');

          // PDF出力ボタンは無効のまま（確定後に有効化）
          document.getElementById('exportButton').disabled = true;
          document.getElementById('confirmButton').disabled = false;

        } else {
          showMessage('エラー: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('通信エラー: ' + error.message, 'error');
      }
    }

    function renderShiftTable(yearMonth, shifts, staffs, requestDates) {
      const [year, month] = yearMonth.split('-').map(Number);
      const daysInMonth = new Date(year, month, 0).getDate();

      // 職員ごとにデータを整理
      const shiftByStaff = {};
      shifts.forEach(shift => {
        if (!shiftByStaff[shift.staffName]) {
          shiftByStaff[shift.staffName] = {};
        }
        shiftByStaff[shift.staffName][shift.date] = shift.shiftName;
      });

      // 職員名の配列を作成（資格者情報を含む）
      const staffNames = staffs.map(s => s.name);

      // テーブルHTML生成（横：日付、縦：職員）
      let html = '<table class="min-w-full border-collapse border border-gray-300 text-sm">';

      // ヘッダー行（日付）
      html += '<thead><tr class="bg-gray-200"><th class="border border-gray-300 p-2 sticky left-0 bg-gray-200 z-10">職員名</th>';
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month - 1, day);
        const weekday = getJapaneseWeekday(date);
        const bgColor = weekday === '日' ? 'bg-red-100' : weekday === '土' ? 'bg-blue-100' : '';
        html += `<th class="border border-gray-300 p-1 ${bgColor}">${day}<br/>(${weekday})</th>`;
      }
      html += '</tr></thead>';

      // データ行（職員ごと）
      html += '<tbody>';
      staffs.forEach(staff => {
        // 職員名（資格者ラベル付き）
        const certLabel = staff.isSuctionCertified ? '<span class="ml-2 text-xs bg-green-500 text-white px-2 py-0.5 rounded">資格者</span>' : '';
        html += `<tr><td class="border border-gray-300 p-2 font-medium sticky left-0 bg-white z-10">${staff.name}${certLabel}</td>`;

        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month - 1, day);
          const dateKey = formatDate(date);
          const shiftName = shiftByStaff[staff.name] ? (shiftByStaff[staff.name][dateKey] || '') : '';

          // 休み希望かチェック
          const isRequestedOff = requestDates[staff.name] && requestDates[staff.name].includes(dateKey);
          const requestLabel = isRequestedOff ? '<div class="text-xs text-red-600 font-bold">休み希望</div>' : '';

          const weekday = getJapaneseWeekday(date);
          const bgColor = weekday === '日' ? 'bg-red-50' : weekday === '土' ? 'bg-blue-50' : '';

          html += `<td class="border border-gray-300 p-1 ${bgColor}">
            ${requestLabel}
            <select
              class="w-full text-xs"
              data-staff="${staff.name}"
              data-date="${dateKey}"
              onchange="updateShift('${staff.name}', '${dateKey}', this.value)"
            >
              <option value="" ${shiftName === '' ? 'selected' : ''}></option>
              <option value="早出" ${shiftName === '早出' ? 'selected' : ''}>早出</option>
              <option value="日勤" ${shiftName === '日勤' ? 'selected' : ''}>日勤</option>
              <option value="遅出" ${shiftName === '遅出' ? 'selected' : ''}>遅出</option>
              <option value="夜勤" ${shiftName === '夜勤' ? 'selected' : ''}>夜勤</option>
              <option value="休み" ${shiftName === '休み' ? 'selected' : ''}>休み</option>
            </select>
          </td>`;
        }

        html += '</tr>';
      });
      html += '</tbody></table>';

      document.getElementById('shiftTableContainer').innerHTML = html;
    }

    function updateShift(staffName, date, shiftName) {
      // currentShiftDataを更新
      const index = currentShiftData.findIndex(s => s.staffName === staffName && s.date === date);
      if (index >= 0) {
        currentShiftData[index].shiftName = shiftName;
      } else {
        // 新規追加
        currentShiftData.push({
          staffName: staffName,
          date: date,
          shiftName: shiftName
        });
      }

      console.log(`更新: ${staffName}, ${date}, ${shiftName}`);
    }

    async function confirmShift() {
      if (!confirm('シフトを確定してスプレッドシートに保存しますか？\n（確定後、PDF出力が可能になります）')) {
        return;
      }

      const data = {
        action: 'confirmShift',
        yearMonth: currentYearMonth,
        groups: currentGroups.join(','),
        shifts: JSON.stringify(currentShiftData)
      };

      try {
        showMessage('シフトを確定中...', 'info');

        const response = await fetch(window.location.href, {
          method: 'POST',
          body: new URLSearchParams(data)
        });

        const result = await response.json();

        if (result.success) {
          currentTableId = result.data.tableId;
          showMessage('シフトを確定しました。PDF出力が可能です。', 'success');

          // PDF出力ボタンを有効化
          document.getElementById('exportButton').disabled = false;
          // 確定ボタンを無効化
          document.getElementById('confirmButton').disabled = true;

        } else {
          showMessage('エラー: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('通信エラー: ' + error.message, 'error');
      }
    }

    async function exportPdf() {
      if (!currentTableId) {
        showMessage('シフト表が確定されていません', 'warning');
        return;
      }

      if (!confirm('PDF出力しますか？')) {
        return;
      }

      const data = {
        action: 'exportPdf',
        tableId: currentTableId
      };

      try {
        showMessage('PDF出力中...', 'info');

        const response = await fetch(window.location.href, {
          method: 'POST',
          body: new URLSearchParams(data)
        });

        const result = await response.json();

        if (result.success) {
          showMessage('PDF出力が完了しました: ' + result.data.fileName, 'success');

          // リンクを表示
          const link = document.createElement('a');
          link.href = result.data.filePath;
          link.target = '_blank';
          link.textContent = 'PDFを開く';
          link.className = 'text-blue-600 underline ml-2';

          const messageDiv = document.getElementById('message');
          messageDiv.appendChild(document.createElement('br'));
          messageDiv.appendChild(link);

        } else {
          showMessage('エラー: ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('通信エラー: ' + error.message, 'error');
      }
    }

    function showPage(page) {
      window.location.href = '?page=' + page;
    }

    function logout() {
      if (confirm('ログアウトしますか？')) {
        window.location.href = '?page=login';
      }
    }

    function showMessage(text, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = text;
      messageDiv.className = type === 'success' ? 'bg-green-50 border border-green-200 text-green-700 p-4 rounded' :
                             type === 'warning' ? 'bg-yellow-50 border border-yellow-200 text-yellow-700 p-4 rounded' :
                             type === 'info' ? 'bg-blue-50 border border-blue-200 text-blue-700 p-4 rounded' :
                             'bg-red-50 border border-red-200 text-red-700 p-4 rounded';
      messageDiv.classList.remove('hidden');

      if (type === 'success' || type === 'error') {
        setTimeout(() => {
          messageDiv.classList.add('hidden');
        }, 5000);
      }
    }

    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}/${month}/${day}`;
    }

    function getJapaneseWeekday(date) {
      const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
      return weekdays[date.getDay()];
    }
  </script>
</body>
</html>
